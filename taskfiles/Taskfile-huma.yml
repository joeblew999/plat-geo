# Huma API Code Generation Tasks
# Usage: task huma:spec, task huma:ts, task huma:all
version: '3'

vars:
  OPENAPI_JSON: openapi.json
  OPENAPI_YAML: openapi.yaml

tasks:
  # Export OpenAPI spec from Huma
  spec:
    desc: Export OpenAPI spec (JSON and YAML)
    cmds:
      - go run cmd/openapi/main.go

  spec:json:
    desc: Export OpenAPI spec as JSON
    cmds:
      - go run cmd/openapi/main.go --format json > {{.OPENAPI_JSON}}

  spec:yaml:
    desc: Export OpenAPI spec as YAML
    cmds:
      - go run cmd/openapi/main.go --format yaml > {{.OPENAPI_YAML}}

  # TypeScript generation (using Bun)
  ts:
    desc: Generate TypeScript types from OpenAPI
    deps: [spec:json]
    cmds:
      - bun x openapi-typescript {{.OPENAPI_JSON}} -o web/src/generated/api.ts

  ts:client:
    desc: Generate TypeScript fetch client
    deps: [spec:json]
    cmds:
      - bun x openapi-typescript {{.OPENAPI_JSON}} -o web/src/generated/api.ts
      - echo "Use openapi-fetch with generated types"

  # Go client generation
  go:client:
    desc: Generate Go client from OpenAPI
    deps: [spec:json]
    cmds:
      - mkdir -p internal/apiclient
      - oapi-codegen -generate types,client -package apiclient {{.OPENAPI_JSON}} > internal/apiclient/client.go

  go:types:
    desc: Generate Go types only
    deps: [spec:json]
    cmds:
      - mkdir -p internal/apitypes
      - oapi-codegen -generate types -package apitypes {{.OPENAPI_JSON}} > internal/apitypes/types.go

  # Mobile clients (optional)
  swift:
    desc: Generate Swift client (iOS)
    deps: [spec:json]
    cmds:
      - openapi-generator-cli generate -i {{.OPENAPI_JSON}} -g swift5 -o generated/swift

  kotlin:
    desc: Generate Kotlin client (Android)
    deps: [spec:json]
    cmds:
      - openapi-generator-cli generate -i {{.OPENAPI_JSON}} -g kotlin -o generated/kotlin

  dart:
    desc: Generate Dart client (Flutter)
    deps: [spec:json]
    cmds:
      - openapi-generator-cli generate -i {{.OPENAPI_JSON}} -g dart -o generated/dart

  # Development tools
  mock:
    desc: Start mock API server (Prism)
    deps: [spec:json]
    cmds:
      - bun x @stoplight/prism-cli mock {{.OPENAPI_JSON}}

  docs:
    desc: Show API docs URL
    cmds:
      - echo "API docs available at http://localhost:8086/docs"

  # Testing
  test:api:
    desc: Run auto-generated API tests (Schemathesis)
    deps: [spec:json]
    cmds:
      - schemathesis run {{.OPENAPI_JSON}} --base-url http://localhost:8086

  # Convenience
  all:
    desc: Generate all (TypeScript types + spec)
    deps: [ts]
    # Note: Go client generation (go:client) disabled due to oapi-codegen OpenAPI 3.1 incompatibility
    # See: https://github.com/oapi-codegen/oapi-codegen/issues/373

  clean:
    desc: Remove generated files
    cmds:
      - rm -f {{.OPENAPI_JSON}} {{.OPENAPI_YAML}}
      - rm -rf web/src/generated/
      - rm -rf internal/apiclient/
      - rm -rf internal/apitypes/
      - rm -rf generated/

  # Install dependencies
  install:
    desc: Install codegen tools
    cmds:
      - go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
      - bun add -d openapi-typescript
      - echo "Tools installed successfully"
