version: "3"

vars:
  BIN_DIR: '{{.BIN_DIR | default ".bin"}}'
  DATA_DIR: '{{.DATA_DIR | default ".data"}}'
  DUCKDB_DIR: '{{.DATA_DIR | default ".data"}}/duckdb'
  DUCKDB: '{{.BIN_DIR | default ".bin"}}/duckdb'
  DUCKDB_FILE: '{{.DATA_DIR | default ".data"}}/duckdb/geo.duckdb'

tasks:
  install:
    desc: Install DuckDB CLI to .bin
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ -f "{{.DUCKDB}}" ]; then
          echo "DuckDB already installed: $({{.DUCKDB}} --version)"
        else
          echo "Installing DuckDB to {{.BIN_DIR}}..."
          curl -fsSL https://install.duckdb.org | DUCKDB_DIR={{.BIN_DIR}} sh
          # Also symlink if installed elsewhere
          if [ ! -f "{{.DUCKDB}}" ] && command -v duckdb &> /dev/null; then
            ln -sf $(which duckdb) {{.DUCKDB}}
          fi
        fi

  install:preview:
    desc: Install DuckDB preview/nightly build to .bin
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - curl -fsSL https://install.duckdb.org | DUCKDB_DIR={{.BIN_DIR}} sh -s -- --preview

  extensions:
    desc: Install spatial and parquet extensions
    cmds:
      - '{{.DUCKDB}} -c "INSTALL spatial; INSTALL parquet;"'

  extensions:community:
    desc: Install geography from community extensions
    cmds:
      - '{{.DUCKDB}} -c "INSTALL geography FROM community; INSTALL spatial; INSTALL parquet;"'

  shell:
    desc: Open DuckDB shell
    cmds:
      - mkdir -p {{.DUCKDB_DIR}}
      - '{{.DUCKDB}} {{.DUCKDB_FILE}}'

  shell:memory:
    desc: Open DuckDB in-memory shell
    cmds:
      - '{{.DUCKDB}}'

  query:
    desc: Run a query (use -- -c "SELECT ...")
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} {{.CLI_ARGS}}'

  load:parquet:
    desc: Load a parquet file into table (FILE=path TABLE=name)
    vars:
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "data"}}'
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "CREATE OR REPLACE TABLE {{.TABLE}} AS SELECT * FROM ''{{.FILE}}'';"'

  load:geoparquet:
    desc: Load a GeoParquet file with geography extension
    vars:
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "geodata"}}'
    cmds:
      - |
        {{.DUCKDB}} {{.DUCKDB_FILE}} -c "
          LOAD geography;
          CREATE OR REPLACE TABLE {{.TABLE}} AS SELECT * FROM '{{.FILE}}';
        "

  info:
    desc: Show database info
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "PRAGMA database_list; SHOW TABLES;"'

  version:
    desc: Show DuckDB version
    cmds:
      - '{{.DUCKDB}} --version'

  # DuckDB UI (web interface)
  ui:install:
    desc: Install DuckDB UI extension
    cmds:
      - '{{.DUCKDB}} -c "INSTALL ui; LOAD ui;"'

  ui:run:
    desc: Start DuckDB UI server (for process-compose)
    vars:
      DUCKDB_UI_PORT: '{{.DUCKDB_UI_PORT | default "4213"}}'
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "LOAD ui; CALL start_ui_server(host := ''0.0.0.0'', port := {{.DUCKDB_UI_PORT}}, open_browser := false); SELECT ''UI running on http://localhost:{{.DUCKDB_UI_PORT}}''; CALL ui_wait();"'

  ui:health:
    desc: Health check for DuckDB UI (for process-compose)
    vars:
      DUCKDB_UI_PORT: '{{.DUCKDB_UI_PORT | default "4213"}}'
    cmds:
      - curl -sf http://localhost:{{.DUCKDB_UI_PORT}}/ > /dev/null

  ui:open:
    desc: Open DuckDB UI in browser
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -ui'
