version: "3"

vars:
  DATA_DIR: '{{.DATA_DIR | default ".data"}}'
  PMTILES_DIR: '{{.DATA_DIR}}/pmtiles'
  TIPPECANOE_IMAGE: 'jskeates/tippecanoe'

tasks:
  tippecanoe-install:
    desc: Install tippecanoe (brew/apt/docker)
    status:
      - command -v tippecanoe &> /dev/null
    cmds:
      - |
        if command -v brew &> /dev/null; then
          brew install tippecanoe
        elif command -v apt &> /dev/null; then
          sudo apt install -y tippecanoe
        else
          echo "No package manager found. Using Docker image: {{.TIPPECANOE_IMAGE}}"
          docker pull {{.TIPPECANOE_IMAGE}}
        fi

  generate:
    desc: Generate PMTiles from GeoJSON
    deps: [tippecanoe-install]
    vars:
      FILE: '{{.FILE}}'
      NAME: '{{.NAME | default "tiles"}}'
      MIN_ZOOM: '{{.MIN_ZOOM | default "0"}}'
      MAX_ZOOM: '{{.MAX_ZOOM | default "14"}}'
    cmds:
      - mkdir -p {{.PMTILES_DIR}}
      - |
        tippecanoe \
          -o {{.PMTILES_DIR}}/{{.NAME}}.pmtiles \
          -Z {{.MIN_ZOOM}} -z {{.MAX_ZOOM}} \
          --drop-densest-as-needed \
          --extend-zooms-if-still-dropping \
          --force \
          {{.FILE}}

  docker:generate:
    desc: Generate PMTiles via Docker
    vars:
      FILE: '{{.FILE}}'
      NAME: '{{.NAME | default "tiles"}}'
    cmds:
      - mkdir -p {{.PMTILES_DIR}}
      - docker pull {{.TIPPECANOE_IMAGE}}
      - |
        docker run --rm \
          -v $(pwd):/data \
          {{.TIPPECANOE_IMAGE}} \
          tippecanoe -o /data/{{.PMTILES_DIR}}/{{.NAME}}.pmtiles -zg --force /data/{{.FILE}}
