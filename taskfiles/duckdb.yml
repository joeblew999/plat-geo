version: "3"

vars:
  BIN_DIR: '{{.BIN_DIR | default ".bin"}}'
  DATA_DIR: '{{.DATA_DIR | default ".data"}}'
  DUCKDB_DIR: '{{.DATA_DIR | default ".data"}}/duckdb'
  DUCKDB: '{{.BIN_DIR | default ".bin"}}/duckdb'
  DUCKDB_FILE: '{{.DATA_DIR | default ".data"}}/duckdb/geo.duckdb'

tasks:
  duckdb-install:
    desc: Install DuckDB
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ -f "{{.DUCKDB}}" ]; then
          echo "DuckDB already installed: $({{.DUCKDB}} --version)"
        else
          echo "Installing DuckDB to {{.BIN_DIR}}..."
          curl -fsSL https://install.duckdb.org | DUCKDB_DIR={{.BIN_DIR}} sh
          if [ ! -f "{{.DUCKDB}}" ] && command -v duckdb &> /dev/null; then
            ln -sf $(which duckdb) {{.DUCKDB}}
          fi
        fi

  extensions:
    desc: Install spatial and parquet extensions
    cmds:
      - '{{.DUCKDB}} -c "INSTALL spatial; INSTALL parquet;"'

  duckdb-shell:
    desc: Open DuckDB shell
    cmds:
      - mkdir -p {{.DUCKDB_DIR}}
      - '{{.DUCKDB}} {{.DUCKDB_FILE}}'

  duckdb-query:
    desc: Execute DuckDB query
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} {{.CLI_ARGS}}'

  duckdb-info:
    desc: Show databases and tables
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "PRAGMA database_list; SHOW TABLES;"'

  duckdb-version:
    desc: Show DuckDB version
    cmds:
      - '{{.DUCKDB}} --version'

  load:parquet:
    desc: Load Parquet file into DuckDB table
    vars:
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "data"}}'
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "CREATE OR REPLACE TABLE {{.TABLE}} AS SELECT * FROM ''{{.FILE}}'';"'

  load:geoparquet:
    desc: Load GeoParquet with geography extension
    vars:
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "geodata"}}'
    cmds:
      - |
        {{.DUCKDB}} {{.DUCKDB_FILE}} -c "
          LOAD geography;
          CREATE OR REPLACE TABLE {{.TABLE}} AS SELECT * FROM '{{.FILE}}';
        "
