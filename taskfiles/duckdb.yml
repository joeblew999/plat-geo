version: "3"

vars:
  BIN_DIR: '{{.BIN_DIR | default ".bin"}}'
  DATA_DIR: '{{.DATA_DIR | default ".data"}}'
  DUCKDB_DIR: '{{.DATA_DIR | default ".data"}}/duckdb'
  DUCKDB: '{{.BIN_DIR | default ".bin"}}/duckdb'
  DUCKDB_FILE: '{{.DATA_DIR | default ".data"}}/duckdb/geo.duckdb'

tasks:
  duckdb-install:
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - |
        if [ -f "{{.DUCKDB}}" ]; then
          echo "DuckDB already installed: $({{.DUCKDB}} --version)"
        else
          echo "Installing DuckDB to {{.BIN_DIR}}..."
          curl -fsSL https://install.duckdb.org | DUCKDB_DIR={{.BIN_DIR}} sh
          # Also symlink if installed elsewhere
          if [ ! -f "{{.DUCKDB}}" ] && command -v duckdb &> /dev/null; then
            ln -sf $(which duckdb) {{.DUCKDB}}
          fi
        fi

  duckdb-install:preview:
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - curl -fsSL https://install.duckdb.org | DUCKDB_DIR={{.BIN_DIR}} sh -s -- --preview

  extensions:
    cmds:
      - '{{.DUCKDB}} -c "INSTALL spatial; INSTALL parquet;"'

  extensions:community:
    cmds:
      - '{{.DUCKDB}} -c "INSTALL geography FROM community; INSTALL spatial; INSTALL parquet;"'

  duckdb-shell:
    cmds:
      - mkdir -p {{.DUCKDB_DIR}}
      - '{{.DUCKDB}} {{.DUCKDB_FILE}}'

  duckdb-shell:memory:
    cmds:
      - '{{.DUCKDB}}'

  duckdb-query:
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} {{.CLI_ARGS}}'

  load:parquet:
    vars:
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "data"}}'
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "CREATE OR REPLACE TABLE {{.TABLE}} AS SELECT * FROM ''{{.FILE}}'';"'

  load:geoparquet:
    vars:
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "geodata"}}'
    cmds:
      - |
        {{.DUCKDB}} {{.DUCKDB_FILE}} -c "
          LOAD geography;
          CREATE OR REPLACE TABLE {{.TABLE}} AS SELECT * FROM '{{.FILE}}';
        "

  duckdb-info:
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "PRAGMA database_list; SHOW TABLES;"'

  duckdb-version:
    cmds:
      - '{{.DUCKDB}} --version'

  # DuckDB UI (web interface)
  ui:setup:
    cmds:
      - '{{.DUCKDB}} -c "INSTALL ui; LOAD ui;"'

  ui:run:
    vars:
      DUCKDB_UI_PORT: '{{.DUCKDB_UI_PORT | default "4213"}}'
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -c "LOAD ui; CALL start_ui_server(host := ''0.0.0.0'', port := {{.DUCKDB_UI_PORT}}, open_browser := false); SELECT ''UI running on http://localhost:{{.DUCKDB_UI_PORT}}''; CALL ui_wait();"'

  ui:health:
    vars:
      DUCKDB_UI_PORT: '{{.DUCKDB_UI_PORT | default "4213"}}'
    cmds:
      - curl -sf http://localhost:{{.DUCKDB_UI_PORT}}/ > /dev/null

  ui:open:
    cmds:
      - '{{.DUCKDB}} {{.DUCKDB_FILE}} -ui'

  # DuckLake (lakehouse catalog)
  lake:setup:
    cmds:
      - '{{.DUCKDB}} -c "INSTALL ducklake;"'

  lake:init:
    vars:
      DUCKLAKE_CATALOG: '{{.DUCKLAKE_CATALOG | default "geo_catalog"}}'
      CATALOG_PATH: '{{.DATA_DIR}}/{{.DUCKLAKE_CATALOG}}.duckdb'
    cmds:
      - |
        {{.DUCKDB}} -c "
          LOAD ducklake;
          ATTACH 'ducklake:{{.CATALOG_PATH}}' AS {{.DUCKLAKE_CATALOG}};
        "
      - echo "DuckLake catalog initialized at {{.CATALOG_PATH}}"

  lake:shell:
    vars:
      DUCKLAKE_CATALOG: '{{.DUCKLAKE_CATALOG | default "geo_catalog"}}'
      CATALOG_PATH: '{{.DATA_DIR}}/{{.DUCKLAKE_CATALOG}}.duckdb'
    cmds:
      - |
        {{.DUCKDB}} -init <(echo "
          LOAD ducklake;
          ATTACH 'ducklake:{{.CATALOG_PATH}}' AS {{.DUCKLAKE_CATALOG}};
          USE {{.DUCKLAKE_CATALOG}};
        ")

  lake:tables:
    vars:
      DUCKLAKE_CATALOG: '{{.DUCKLAKE_CATALOG | default "geo_catalog"}}'
      CATALOG_PATH: '{{.DATA_DIR}}/{{.DUCKLAKE_CATALOG}}.duckdb'
    cmds:
      - |
        {{.DUCKDB}} -c "
          LOAD ducklake;
          ATTACH 'ducklake:{{.CATALOG_PATH}}' AS {{.DUCKLAKE_CATALOG}};
          SHOW ALL TABLES;
        "

  lake:ingest:parquet:
    vars:
      DUCKLAKE_CATALOG: '{{.DUCKLAKE_CATALOG | default "geo_catalog"}}'
      CATALOG_PATH: '{{.DATA_DIR}}/{{.DUCKLAKE_CATALOG}}.duckdb'
      FILE: '{{.FILE}}'
      TABLE: '{{.TABLE | default "data"}}'
      SCHEMA: '{{.SCHEMA | default "main"}}'
    cmds:
      - |
        {{.DUCKDB}} -c "
          LOAD ducklake;
          ATTACH 'ducklake:{{.CATALOG_PATH}}' AS {{.DUCKLAKE_CATALOG}};
          CREATE OR REPLACE TABLE {{.DUCKLAKE_CATALOG}}.{{.SCHEMA}}.{{.TABLE}} AS
            SELECT * FROM '{{.FILE}}';
        "

  lake:snapshots:
    vars:
      DUCKLAKE_CATALOG: '{{.DUCKLAKE_CATALOG | default "geo_catalog"}}'
      CATALOG_PATH: '{{.DATA_DIR}}/{{.DUCKLAKE_CATALOG}}.duckdb'
    cmds:
      - |
        {{.DUCKDB}} -c "
          LOAD ducklake;
          ATTACH 'ducklake:{{.CATALOG_PATH}}' AS {{.DUCKLAKE_CATALOG}};
          SELECT * FROM ducklake_snapshots('{{.DUCKLAKE_CATALOG}}');
        "
