version: "3"

vars:
  DATA_DIR: '{{.DATA_DIR | default ".data"}}'
  NORNICDB_IMAGE: '{{.NORNICDB_IMAGE | default "timothyswt/nornicdb-arm64-metal-bge-heimdall:latest"}}'
  NORNICDB_CONTAINER: '{{.NORNICDB_CONTAINER | default "nornicdb"}}'
  NORNICDB_HTTP_PORT: '{{.NORNICDB_HTTP_PORT | default "7474"}}'
  NORNICDB_BOLT_PORT: '{{.NORNICDB_BOLT_PORT | default "7687"}}'

tasks:
  pull:
    desc: Pull NornicDB Docker image
    cmds:
      - docker pull {{.NORNICDB_IMAGE}}

  nornicdb-start:
    desc: Start NornicDB as daemon
    cmds:
      - mkdir -p {{.DATA_DIR}}/nornicdb
      - |
        docker run -d \
          --name {{.NORNICDB_CONTAINER}} \
          -p {{.NORNICDB_HTTP_PORT}}:7474 \
          -p {{.NORNICDB_BOLT_PORT}}:7687 \
          -v {{.DATA_DIR}}/nornicdb:/data \
          {{.NORNICDB_IMAGE}}
      - echo "NornicDB started at http://localhost:{{.NORNICDB_HTTP_PORT}}"

  nornicdb-stop:
    desc: Stop NornicDB container
    cmds:
      - docker stop {{.NORNICDB_CONTAINER}} || true
      - docker rm {{.NORNICDB_CONTAINER}} || true

  nornicdb-restart:
    desc: Restart NornicDB
    cmds:
      - task: nornicdb-stop
      - task: nornicdb-start

  nornicdb-health:
    desc: Health check NornicDB
    cmds:
      - curl -sf http://localhost:{{.NORNICDB_HTTP_PORT}}/health > /dev/null

  nornicdb-status:
    desc: Show NornicDB container status
    cmds:
      - docker ps -f name={{.NORNICDB_CONTAINER}} --format "table {{`{{.Names}}`}}\t{{`{{.Status}}`}}\t{{`{{.Ports}}`}}"

  nornicdb-shell:
    desc: Interactive shell in NornicDB container
    cmds:
      - docker exec -it {{.NORNICDB_CONTAINER}} /bin/sh

  nornicdb-clean:
    desc: Delete all NornicDB data
    prompt: This will delete all NornicDB data. Continue?
    cmds:
      - task: nornicdb-stop
      - rm -rf {{.DATA_DIR}}/nornicdb
      - echo "NornicDB data removed"
