# Restish: API testing and exploration
# Maps to .src/restish
# Usage: task restish:health, task restish:smoke
version: '3'

vars:
  BIN_DIR: .bin

tasks:
  restish-install:
    status:
      - test -f {{.BIN_DIR}}/restish
    cmds:
      - GOBIN={{.ROOT_DIR}}/{{.BIN_DIR}} go install github.com/rest-sh/restish@latest

  restish-default:
    deps: [restish-install]
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo --help'

  sync:
    deps: [restish-install]
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish api sync geo'

  restish-health:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo health'

  restish-info:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo get-info'

  layers:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo list-layers'

  sources:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo list-sources -o table'

  tiles:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo list-tiles -o table'

  restish-query:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish geo query {{.CLI_ARGS}}'

  links:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish links http://localhost:8086/'

  smoke:
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - echo "--- health ---" && {{.BIN_DIR}}/restish geo health
      - echo "--- info ---" && {{.BIN_DIR}}/restish geo get-info
      - echo "--- links ---" && {{.BIN_DIR}}/restish links http://localhost:8086/
      - echo "--- sources ---" && {{.BIN_DIR}}/restish geo list-sources -o table
      - echo "--- tiles ---" && {{.BIN_DIR}}/restish geo list-tiles -o table
      - echo "--- layers ---" && {{.BIN_DIR}}/restish geo list-layers
      - echo "--- create layer ---" && {{.BIN_DIR}}/restish geo create-layer < testdata/layer-smoke.json
      - echo "--- get layer ---" && {{.BIN_DIR}}/restish geo get-layer smoke-test
      - echo "--- layer links ---" && {{.BIN_DIR}}/restish links http://localhost:8086/api/v1/layers/smoke-test
      - echo "--- delete layer ---" && {{.BIN_DIR}}/restish geo delete-layer smoke-test
      - echo "--- query ---" && echo '{"query":"SELECT 1 as ok"}' | {{.BIN_DIR}}/restish geo query

  test:client:
    cmds:
      - go test -tags=integration -v -count=1 ./pkg/geoclient/
