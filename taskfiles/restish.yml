# Restish: API testing and exploration
version: '3'

vars:
  BIN_DIR: .bin

tasks:
  restish-install:
    desc: Install restish CLI
    status:
      - test -f {{.BIN_DIR}}/restish
    cmds:
      - GOBIN={{.ROOT_DIR}}/{{.BIN_DIR}} go install github.com/rest-sh/restish@latest

  sync:
    desc: Sync API definitions
    deps: [restish-install]
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - '{{.BIN_DIR}}/restish api sync geo'

  smoke:
    desc: Run API smoke tests
    deps: [restish-install]
    env:
      RESTISH_CONFIG_DIR: .
    cmds:
      - echo "--- health ---" && {{.BIN_DIR}}/restish geo get-health
      - echo "--- info ---" && {{.BIN_DIR}}/restish geo get-api-v1-info
      - echo "--- links ---" && {{.BIN_DIR}}/restish links http://localhost:8086/
      - echo "--- sources ---" && {{.BIN_DIR}}/restish geo get-api-v1-sources -f body.data -o table
      - echo "--- tiles ---" && {{.BIN_DIR}}/restish geo get-api-v1-tiles -f body.data -o table
      - echo "--- layers ---" && {{.BIN_DIR}}/restish geo get-api-v1-layers
      - echo "--- create layer ---" && {{.BIN_DIR}}/restish geo post-api-v1-layers < testdata/layer-smoke.json
      - echo "--- get layer ---" && {{.BIN_DIR}}/restish geo get-api-v1-layers-by-id smoke-test
      - echo "--- layer links ---" && {{.BIN_DIR}}/restish links http://localhost:8086/api/v1/layers/smoke-test
      - echo "--- delete layer ---" && {{.BIN_DIR}}/restish geo delete-api-v1-layers-by-id smoke-test
      - echo "--- query ---" && echo '{"query":"SELECT 1 as ok"}' | {{.BIN_DIR}}/restish geo post-api-v1-query

  test:client:
    desc: Run Go integration tests for geoclient
    cmds:
      - go test -tags=integration -v -count=1 ./pkg/geoclient/
