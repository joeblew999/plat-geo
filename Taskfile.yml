version: "3"

vars:
  BINARY: geo
  BIN_DIR: .bin
  DATA_DIR: .data
  MODULE: github.com/joeblew999/plat-geo

includes:
  huma:
    taskfile: taskfiles/Taskfile-huma.yml
    optional: true
  duckdb:
    taskfile: taskfiles/Taskfile-duckdb.yml
    optional: true
  ducklake:
    taskfile: taskfiles/Taskfile-ducklake.yml
    optional: true
  nornicdb:
    taskfile: taskfiles/Taskfile-nornicdb.yml
    optional: true
  pmtiles:
    taskfile: taskfiles/Taskfile-pmtiles.yml
    optional: true
  tippecanoe:
    taskfile: taskfiles/Taskfile-tippecanoe.yml
    optional: true

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # ===================
  # DEVELOPMENT - ONE WAY: task dev
  # ===================
  dev:
    desc: Run dev server with hot reload and codegen
    cmds:
      - air

  # ===================
  # BUILD
  # ===================
  build:
    desc: Build the binary
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - go build -o {{.BIN_DIR}}/{{.BINARY}} ./cmd/{{.BINARY}}

  build:release:
    desc: Build optimized release binary
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - CGO_ENABLED=0 go build -ldflags="-s -w" -o {{.BIN_DIR}}/{{.BINARY}} ./cmd/{{.BINARY}}

  # ===================
  # TESTING
  # ===================
  test:
    desc: Run tests
    cmds:
      - go test -v ./...

  test:coverage:
    desc: Run tests with coverage
    cmds:
      - go test -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html

  # ===================
  # CODE QUALITY
  # ===================
  lint:
    desc: Run linter
    cmds:
      - golangci-lint run

  fmt:
    desc: Format code
    cmds:
      - go fmt ./...
      - goimports -w .

  # ===================
  # DEPENDENCIES
  # ===================
  deps:
    desc: Download dependencies
    cmds:
      - go mod download

  deps:tidy:
    desc: Tidy dependencies
    cmds:
      - go mod tidy

  # ===================
  # CLEAN
  # ===================
  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BIN_DIR}} .tmp
      - rm -f coverage.out coverage.html openapi.json openapi.yaml

  # ===================
  # DATA
  # ===================
  data:init:
    desc: Initialize data directory with sample files
    cmds:
      - mkdir -p {{.DATA_DIR}}/tiles {{.DATA_DIR}}/sources
      - cp -n testdata/*.geojson {{.DATA_DIR}}/sources/ 2>/dev/null || true

  # ===================
  # INSTALL
  # ===================
  install:
    desc: Install binary locally via xplat
    cmds:
      - xplat binary install {{.BINARY}} v0.1.0 joeblew999/plat-geo --source ./cmd/{{.BINARY}} --force

  install:go:
    desc: Install binary to GOPATH/bin
    cmds:
      - go install ./cmd/{{.BINARY}}

  # ===================
  # RELEASE
  # ===================
  release:build:
    desc: Build release binaries for all platforms
    cmds:
      - xplat release build {{.BINARY}}

  release:build:current:
    desc: Build release binary for current platform
    cmds:
      - xplat release build {{.BINARY}} --current

  release:list:
    desc: List built release binaries
    cmds:
      - xplat release list {{.BINARY}}
