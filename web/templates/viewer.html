<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>plat-geo - Map Viewer</title>
    <link rel="stylesheet" href="/static/css/vendor/leaflet.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 16px;
            max-width: 300px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 1000;
        }

        .info-panel h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .layer-item label {
            cursor: pointer;
            flex: 1;
        }

        .legend {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #ddd;
        }

        .legend h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 13px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .panel-toggle {
            display: none;
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 24px;
            z-index: 1001;
        }

        @media (max-width: 600px) {
            .info-panel {
                top: auto;
                bottom: 80px;
                left: 10px;
                right: 10px;
                max-width: none;
                max-height: 40vh;
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }

            .info-panel.open {
                transform: translateY(0);
            }

            .panel-toggle {
                display: block;
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="panel" class="info-panel">
        <h2>Layers</h2>
        <div id="layer-list">
            <div class="loading">Loading layers...</div>
        </div>
        <div id="legend" class="legend" style="display: none;">
            <h3>Legend</h3>
            <div id="legend-items"></div>
        </div>
    </div>

    <button id="panel-toggle" class="panel-toggle">
        <span id="toggle-icon">&#9650;</span>
    </button>

    <script src="/static/js/vendor/leaflet.js"></script>
    <script src="/static/js/vendor/pmtiles.js"></script>
    <script src="/static/js/vendor/protomaps-leaflet.js"></script>
    <script>
        // Configuration
        const TILES_BASE = '/tiles';
        let map;
        let mapLayers = {};
        let layerConfigs = {};

        // Initialize map
        function initMap() {
            // Default to Firenze (Florence, Italy) for the sample data
            map = L.map('map').setView([43.7696, 11.2558], 13);

            // Base layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // Build paint rules from layer config
        function buildPaintRules(layer) {
            if (!layer.renderRules || layer.renderRules.length === 0) {
                // Default style
                const defaultStyle = {
                    fill: layer.fill || '#3388ff',
                    stroke: layer.stroke || '#2266cc',
                    opacity: layer.opacity || 0.6,
                    width: 1
                };

                if (layer.geomType === 'point') {
                    return [{
                        dataLayer: layer.pmtilesLayer,
                        symbolizer: new protomapsL.CircleSymbolizer({
                            ...defaultStyle,
                            radius: 5
                        })
                    }];
                }
                return [{
                    dataLayer: layer.pmtilesLayer,
                    symbolizer: new protomapsL.PolygonSymbolizer(defaultStyle)
                }];
            }

            return layer.renderRules.map(rule => {
                const ruleObj = { dataLayer: layer.pmtilesLayer };

                // Add filter if specified
                if (rule.filterProp && rule.filterValue) {
                    const prop = rule.filterProp;
                    const value = rule.filterValue;
                    ruleObj.filter = (z, f) => f.props[prop] === value;
                }

                const style = {
                    fill: rule.fill || '#3388ff',
                    stroke: rule.stroke || rule.fill || '#2266cc',
                    opacity: rule.opacity || 0.6,
                    width: rule.width || 1
                };

                if (layer.geomType === 'point') {
                    ruleObj.symbolizer = new protomapsL.CircleSymbolizer({
                        ...style,
                        radius: rule.radius || 5
                    });
                } else {
                    ruleObj.symbolizer = new protomapsL.PolygonSymbolizer(style);
                }

                return ruleObj;
            });
        }

        // Load layer onto map
        function loadLayer(layerId, config) {
            // Support both local files and remote URLs
            const pmtilesUrl = config.file.startsWith('http')
                ? config.file
                : `${TILES_BASE}/${config.file}`;
            const paintRules = buildPaintRules(config);

            const layer = protomapsL.leafletLayer({
                url: pmtilesUrl,
                paintRules: paintRules
            });

            mapLayers[layerId] = layer;
            layerConfigs[layerId] = config;

            if (config.defaultVisible) {
                layer.addTo(map);
            }
        }

        // Render layer list
        function renderLayerList(layers) {
            const container = document.getElementById('layer-list');
            container.innerHTML = '';

            Object.entries(layers).forEach(([id, config]) => {
                const div = document.createElement('div');
                div.className = 'layer-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `layer-${id}`;
                checkbox.checked = config.defaultVisible;
                checkbox.addEventListener('change', (e) => {
                    const layer = mapLayers[id];
                    if (e.target.checked) {
                        map.addLayer(layer);
                    } else {
                        map.removeLayer(layer);
                    }
                    updateLegend();
                });

                const label = document.createElement('label');
                label.htmlFor = `layer-${id}`;
                label.textContent = config.name;

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);

                // Load the layer
                loadLayer(id, config);
            });

            updateLegend();
        }

        // Update legend based on visible layers
        function updateLegend() {
            const legendDiv = document.getElementById('legend');
            const legendItems = document.getElementById('legend-items');
            legendItems.innerHTML = '';

            let hasLegend = false;

            Object.entries(layerConfigs).forEach(([id, config]) => {
                const checkbox = document.getElementById(`layer-${id}`);
                if (!checkbox.checked || !config.legend) return;

                hasLegend = true;
                config.legend.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';

                    const color = document.createElement('div');
                    color.className = 'legend-color';
                    color.style.backgroundColor = entry.color;

                    const label = document.createElement('span');
                    label.textContent = entry.label;

                    item.appendChild(color);
                    item.appendChild(label);
                    legendItems.appendChild(item);
                });
            });

            legendDiv.style.display = hasLegend ? 'block' : 'none';
        }

        // Mobile panel toggle
        function initPanelToggle() {
            const panel = document.getElementById('panel');
            const toggle = document.getElementById('panel-toggle');
            const icon = document.getElementById('toggle-icon');

            toggle.addEventListener('click', () => {
                panel.classList.toggle('open');
                icon.innerHTML = panel.classList.contains('open') ? '&#9660;' : '&#9650;';
            });
        }

        // Fetch layers from API
        async function fetchLayers() {
            try {
                const response = await fetch('/api/v1/layers');
                if (!response.ok) throw new Error('Failed to fetch layers');
                const layers = await response.json();
                renderLayerList(layers);
            } catch (error) {
                console.error('Error fetching layers:', error);
                document.getElementById('layer-list').innerHTML =
                    '<div style="color: #999; padding: 10px;">No layers configured</div>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initPanelToggle();
            fetchLayers();
        });
    </script>
</body>
</html>
